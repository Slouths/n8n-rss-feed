name: Update RSS Feed

on:
  workflow_dispatch:   # Manual trigger
  schedule:
    - cron: "*/5 * * * *"   # Every 5 minutes (for testing)

permissions:
  contents: write   # Needed to push changes to the repo

jobs:
  update-feed:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Configure Git for commit
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "action@github.com"

      # 3. Ensure rss.xml exists (create if missing)
      - name: Ensure rss.xml exists
        run: |
          if [ ! -f rss.xml ]; then
            cat <<EOF > rss.xml
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
  <channel>
    <title>n8n Test Feed</title>
    <link>https://slouths.github.io/n8n-rss-feed/</link>
    <description>Testing RSS automation for n8n</description>
  </channel>
</rss>
EOF
          fi

      # 4. Add new article to feed
      - name: Add new article
        run: |
          TITLE="Test Article $(date +'%Y-%m-%d %H:%M:%S')"
          LINK="https://example.com/article-$(date +%s)"
          PUBDATE="$(date -u +'%a, %d %b %Y %H:%M:%S GMT')"

          NEW_ITEM="<item>
    <title>$TITLE</title>
    <link>$LINK</link>
    <guid>$LINK</guid>
    <pubDate>$PUBDATE</pubDate>
  </item>"

          # Insert new item right after <channel> and keep only 10 items
          awk -v newItem="$NEW_ITEM" '
            /<channel>/ {print; print newItem; next}
            /<\/channel>/ {next}
            {print}
          ' rss.xml | awk '
            BEGIN {itemCount=0}
            /<item>/ {itemCount++}
            {print}
            /<\/item>/ && itemCount>=10 {exit}
          END {print "</channel>\n</rss>"}' > rss.tmp && mv rss.tmp rss.xml

      # 5. Commit and push changes
      - name: Commit and push
        run: |
          git add rss.xml
          git commit -m "Update RSS feed with new article" || echo "No changes to commit"
          git push
